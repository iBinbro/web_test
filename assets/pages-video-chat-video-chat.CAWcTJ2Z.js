import{_ as e,j as l,u as a,F as o,h as t,k as s,V as n,av as c,aX as u,aY as i,c as r,aZ as d,ae as v,n as g,a_ as f,J as p,aO as m,H as h,o as y,d as b,w as k,a$ as C,af as _,b0 as I,b1 as w,b2 as D,b3 as U,b4 as $,i as E,e as F,W as T,a3 as R,P as j,Q as B,T as M,R as P,S,a4 as x,L as A,N as O,O as V,au as q,aP as G,b5 as L,b6 as K,aQ as N,b7 as z,aS as J,an as H,b8 as Q,b9 as W,ba as X,a2 as Y,aT as Z,bb as ee,bc as le,ar as ae}from"./index-SUU5mfSv.js";import{_ as oe}from"./z-paging.CcGAQywI.js";import{d as te,c as se,r as ne}from"./uni-app.es.BFzw-cPf.js";import"./picker.CIoOQAKU.js";import{M as ce,G as ue}from"./gift-effect.7ERhjfhJ.js";const ie=e({__name:"video-chat",setup(e){var ie,re;ae({callBusy:!0,action:!0});const de=l(!1),ve=l("");l();const ge=l(!1),fe=l(0),pe=l(!1),me=()=>{console.log(`发送消息 ${ve.value}`),""==ve.value||(Je.value.unshift({type:3,content:ve.value}),1!=Pe.value&&N({str:ve.value,channelId:Be,receiveId:Ve.value,matchCallBack:e=>{z({recipientId:Ve.value,type:23,content:e,ignoreNetRequest:null==e,userDetail:Ee.value,channelId:Be,success:()=>{}})}}),ve.value="",fe.value=0,pe.value=!1,de.value=!1,ge.value=!1)},he=()=>{pe.value=!1,console.log("失去焦点 记录此时输入框的输入光标位置");const e=document.getElementById("inputElement").querySelector("input").selectionEnd;fe.value=e},ye=e=>{e.stopPropagation(),de.value=!0,console.log("表情板"),ge.value=!ge.value,J((()=>{if(ge.value){const e=document.createElement("style");e.textContent=".search-row, .pad-top { display: none; }",document.querySelector("emoji-picker").shadowRoot.appendChild(e),document.querySelector("emoji-picker").addEventListener("emoji-click",(e=>{const l=e.detail.unicode;document.getElementById("inputElement").querySelector("input");const a=fe.value,o=fe.value;ve.value=ve.value.slice(0,a)+l+ve.value.slice(o),fe.value=fe.value+l.length}))}else pe.value=!0}))},be=a().$onAction((({name:e,args:l})=>{var a,o;if("addMsgInCall"==e){console.log("收到了通话中主播发送的消息");const e=l[0];(null==(a=null==e?void 0:e.userInfo)?void 0:a.uid)==Ve.value&&Je.value.unshift({type:4,content:null==(o=null==e?void 0:e.data)?void 0:o.text})}}));o((()=>{document.querySelector(".zp-paging-container").addEventListener("touchstart",(function(e){de.value=!1,ge.value=!1}))}));const ke=l(),Ce=e=>{Ke+=e.diamonds,ke.value.throwGiftEffect(e)},_e=l(!1),Ie=e=>{_e.value=e},we=e=>{0==De.value&&(e&&H({content:e}),Ae.value=1==Pe.value?n.aivGiftRecharge:n.callGiftRecharge,Ue(!0))},De=l(!1),Ue=e=>{De.value=e},$e=e=>{Ae.value=e,Ue(!0)},{userDetail:Ee}=t(a()),Fe=l(!0),Te=l(!1),Re=e=>{Te.value=e};let je=[];const Be=s("videoCallChannelId"),Me=s("videoCallData"),Pe=l(Me.type),Se=l(0),xe=l(null),Ae=l(1==Pe.value?n.aivRechargeBtn:n.callRechargeBtn),Oe=l({}),Ve=l(Me.anchorUserId);c({anchorUserId:Me.anchorUserId,success:e=>{Oe.value=e}});let qe=0,Ge=0;const Le=l("00:00");let Ke=0,Ne=!1;const ze=l(!0),Je=l(),He=()=>{nl(),1!=Pe.value&&C(),console.log("通话流程 通话结束 进入结算页面"),_({url:"/pages/video-chat/video-chat-end"})},Qe=e=>{Re(!1),e?(console.log("用户确认了挂断"),He()):console.log("用户取消了挂断")},We=({success:e=()=>{}})=>{const l=Q({channelId:Be,success:l=>{console.log("通话流程 renewToken Rtc Token续期");try{ee(l),e()}catch(a){console.log("通话流程 Rtc token 续期失败 进入结算页面"),He()}},fail:()=>{console.log("通话流程 RefreshCall失败 进入结算页"),He()},netFail:()=>{console.log("通话流程 RefreshCall失败 进入结算页"),He()}});je.push(l)},Xe=()=>{$(),le(setInterval((()=>{if(console.log(`通话流程 虚拟视频/真实通话计时 ${Ge}`),1==Pe.value){console.log("通话流程 虚拟视频 本地记录下结算信息以便结算页面本地获取");const e={totalCallTime:Ge,usedMatchPropFlag:Ne,giftAmount:Ke,isAiv:null==Me?void 0:Me.isAiv};v({key:"virtualVideoEnd",value:e})}else{console.log("通话流程 真实通话记录本地的计时器时长 结算页面获取传递给服务器");v({key:"virtualVideoEnd",value:{totalCallTime:Ge}}),console.log("通话流程 真实通话计时(主播加入频道开启计时)"),0!=Ge&&(Ge-qe)%60==0&&(console.log(`通话流程 refreshCall 一次 ${Ge}`),We({}))}Ge++;const e=String(Math.floor(Ge/60)).padStart(2,"0"),l=String(Ge%60).padStart(2,"0");Le.value=`${e}:${l}`,1==Pe.value&&Ge>=20&&(console.log("通话流程 虚拟视频超出20s 强制结束进入结算页面"),He())}),1e3))},Ye=l(),Ze=()=>{var e;console.log(`通话流程 公屏 onRefresh ${Pe.value}`),Je.value=[{type:0,content:g.videoCallWarning.tr}],1==(null==Me?void 0:Me.voiceFlag)&&Je.value.unshift({type:1,content:g.videoCallMutedTip.tr}),null==(e=Ye.value)||e.complete(!0)};Ze();const el=({failTip:e=!1})=>{I({localMediaTrack:e=>{Fe.value=!0;const l=document.getElementById("local-user");e.play(l),Je.value=Je.value.filter((e=>2!=e.type)),f("success"),v({key:"devicePermission",value:!0})},supportError:l=>{console.log("通话流程 加入频道开启本地串流失败"),Fe.value=!1;const a=s("devicePermission");!0===a?(console.log("通话权限 原允许实际开启失败 插入权限提示"),Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})):!1!==a&&(console.log("通话权限 原未知变为拒绝 更换权限提示"),Je.value=Je.value.filter((e=>2!=e.type)),Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})),f(null==l?void 0:l.code),v({key:"devicePermission",value:!1}),e&&p()}})};if(1==Pe.value)console.log("通话流程 虚拟视频"),null==(re=null==(ie=Ee.value)?void 0:ie.propVoList)||re.forEach((e=>{5==(null==e?void 0:e.propType)&&(null==e?void 0:e.propNum)>0&&(Ne=!0,console.log("通话流程 虚拟视频情况下用户有匹配卡 则结算页面显示死耗费了匹配卡"))}));else{console.log("通话流程 真实通话"),u({remoteMediaTrack:e=>{console.log("通话流程 将主播推流显示到页面");const l=document.getElementById("remote-anchor");e.play(l)},userJoinChannel:e=>{console.log(`通话流程 用户加入了当前通话 如果是主播则开始通话计时 ${e}`),e==Me.anchorUserId&&(console.log(`通话流程 主播加入了通话 关闭主播加入超时器 并refreshCall ${e}`),w(),We({success:()=>{console.log("通话流程 第一次refreshcall成功 开始计时"),Xe()}}))},userLeftChannel:e=>{console.log(`通话流程 用户离开了当前通话 如果是主播则开始通话结束 ${e}`),e==Me.anchorUserId&&(console.log(`通话流程 主播离开了当前通话 通话结束 ${e}`),He())}});let e=i();if(null==e||null==e||e.length<=0)console.log("通话流程 Agora appId无效 重新调用接口获取并进入结算页面"),r({}),He();else if(console.log("通话流程 获取本地存储的频道"),null!=Be&&null!=Be&&""!=Be){const l=d({channelId:Be,success:l=>{Me.remoteInvite&&(console.log(`通话流程 主播主动发送的通话邀请 免费时长${Me.content.freeTime}`),qe+=Me.content.freeTime),l.usedCallCard?(console.log(`通话流程 本次通话使用了视频卡 免费时长为${l.callCardSeconds}`),qe+=l.callCardSeconds,Je.value.unshift({type:0,content:g.videoCardUsedTip.trArg(qe)})):2==l.callType?(console.log(`通话流程 本次是匹配进入的真实通话 免费时长为${l.matchCardSeconds}`),qe+=l.matchCardSeconds):Me.remoteInvite&&qe>0&&console.log(`本次是主播主叫进入的真实通话 附送了免费时长为${qe}`),qe>0&&Je.value.unshift({type:0,content:g.videoCallCostTip.trArgs({para:qe,para1:l.chargePrice.toBin})}),D({appId:e,channel:Be,token:l.rtcToken,uid:Ee.value.userId,fail:()=>{console.log("通话流程 Rtc joinChannel失败 进入结算页"),He()},success:()=>{console.log("通话流程 自己加入频道成功 开启15秒定时器 如果主播超时加入则结束通话"),U(setTimeout((()=>{console.log("通话流程 主播超时未能加入频道 结束频道"),He()}),15e3)),console.log("通话流程 用户加入成功 开始判断是否本地推流");const e=s("devicePermission");!0===e?(console.log("通话流程 用户接受过权限 则直接本地推流"),el({})):!1===e?(console.log("通话流程 权限拒绝"),Fe.value=!1,Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})):(console.log("通话流程 权限待定"),Fe.value=!1,Je.value.unshift({type:2,content:g.mediaDiveceUnknown.tr}))}})},fail:()=>{console.log("通话流程 JoinCall失败 进入结算页"),He()},netFail:()=>{console.log("通话流程 JoinCall失败 进入结算页"),He()}});je.push(l)}else console.log("通话流程 读取本地存储的channelId失败 进入结算页"),He()}te((()=>{if(console.log("通话流程 video call onReady"),null==Me||null==Me||1==(null==Me?void 0:Me.disable))console.log("通话流程 异常刷新了视频通话的页面 此时强制进入结算页面"),He();else if(Se.value=null==Me?void 0:Me.voiceFlag,Me.disable=!0,v({key:"videoCallData",value:Me}),1==Pe.value){console.log("通话流程 是虚拟视频 开始获取摄像头流以及播放视频");const e=s("devicePermission");!0===e?(console.log("通话流程 用户接受过权限 则直接本地推流"),sl({})):!1===e?(console.log("通话流程 权限拒绝"),tl.value=!1,Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})):(console.log("通话流程 权限待定"),tl.value=!1,Je.value.unshift({type:2,content:g.mediaDiveceUnknown.tr})),xe.value=Me.url}else console.log("通话流程 真人通话流程"),(Me.remoteInvite||Me.localInvite)&&console.log("通话流程 主播/用户 主动发起的通话申请")}));const ll=()=>{console.log("通话流程 虚拟视频播放开始 进行扣费和计时"),Xe(),!0===(null==Me?void 0:Me.isAiv)?console.log("AII aiv虚拟视频免费"):(console.log("匹配的虚拟视频扣费"),W({anchorUserId:Me.anchorUserId}))},al=()=>{console.log("通话流程 虚拟视频播放错误 结束视频"),He()};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var l=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return l?new Promise((function(a,o){l.call(navigator,e,a,o)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))});let ol=null;const tl=l(!1),sl=({failTip:e=!1})=>{if(1!=Pe.value)return console.log("通话流程 真实通话 手动开启本地串流"),void el({failTip:!0});navigator.mediaDevices.getUserMedia({audio:!0,video:{width:120,height:160,facingMode:"user",frameRate:{ideal:10,max:15}}}).then((function(e){console.log("通话流程 摄像头getUserMedia获取成功"),tl.value=!0,ol=e;var l=document.querySelector("#user-camera video");"srcObject"in l?l.srcObject=ol:l.src=window.URL.createObjectURL(ol),l.onloadedmetadata=function(e){l.play()},Je.value=Je.value.filter((e=>2!=e.type)),f("success"),v({key:"devicePermission",value:!0})})).catch((function(l){console.log("通话流程 摄像头getUserMedia获取失败"),tl.value=!1;const a=s("devicePermission");!0===a?(console.log("通话流程 本地记录为允许权限的情况下 开启设备失败 插入启用提醒"),Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})):!1!==a&&(console.log("通话权限 原未知变为拒绝 更换权限提示"),Je.value=Je.value.filter((e=>2!=e.type)),Je.value.unshift({type:2,content:g.mediaDiveceDisable.tr})),f(null==l?void 0:l.name),v({key:"devicePermission",value:!1}),e&&p()}))},nl=()=>{$(),w(),1==Pe.value&&(console.log("通话流程 虚拟视频结束 需要关闭本地摄像头流"),null!=ol&&ol.getTracks().forEach((e=>e.stop())),ol=null)};return se((()=>{ae({callBusy:!0,action:!1}),be(),console.log("通话流程 通话页面释放"),je.forEach((e=>{console.log(`取消一个网络请求 ${e}`),null==e||e.abort()})),nl()})),(e,l)=>{const a=X,o=E,t=Y,s=Z,c=m("emoji-picker"),u=ne(h("z-paging"),oe);return y(),b(o,{class:"video-chat-content"},{default:k((()=>{var i,r;return[F(o,{class:"display-video",style:R({backgroundImage:`url(${null==(i=Oe.value)?void 0:i.portrait})`})},{default:k((()=>[1==Pe.value&&null!=xe.value?(y(),b(a,{key:0,class:"anchor-video",id:"anchor-video",autoplay:!0,loop:!1,muted:!0,"enable-play-gesture":!1,"enable-progress-gesture":!1,controls:!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"show-loading":!1,"show-mute-btn":!1,"show-play-btn":!1,"show-progress":!1,"object-fit":"cover",src:xe.value,onPlay:ll,onEnded:He,onError:al},null,8,["src"])):1!=Pe.value?(y(),b(o,{key:1,id:"remote-anchor",class:"anchor-video"})):T("",!0)])),_:1},8,["style"]),F(o,{class:"display-camera",style:R({backgroundImage:`url(${null==(r=M(Ee))?void 0:r.portrait})`})},{default:k((()=>[1==Pe.value?j((y(),b(a,{key:0,class:"camera",id:"user-camera",autoplay:!0,loop:!1,muted:!0,"enable-play-gesture":!1,"enable-progress-gesture":!1,controls:!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"show-loading":!1,"show-mute-btn":!1,"show-play-btn":!1,"show-progress":!1,"object-fit":"cover"},null,512)),[[B,tl.value]]):1!=Pe.value?(y(),b(o,{key:1,id:"local-user",class:"camera"})):T("",!0),1!=Pe.value&&!Fe.value||1==Pe.value&&!tl.value?(y(),b(o,{key:2,class:"device-disable"},{default:k((()=>[F(o,{class:"tip-img",onClick:l[0]||(l[0]=e=>sl({failTip:!0}))})])),_:1})):T("",!0)])),_:1},8,["style"]),F(o,{class:"nav-tool-bar"},{default:k((()=>[F(o,{class:"anchor-content"},{default:k((()=>[F(o,{class:"anchor-detail"},{default:k((()=>{var e;return[F(o,{class:"anchor-portrait",style:R({backgroundImage:`url(${null==(e=Oe.value)?void 0:e.portrait})`})},null,8,["style"]),F(o,{class:"anchor-info"},{default:k((()=>[F(o,{class:"area"},{default:k((()=>{var e;return[F(o,{class:"countryIcon",style:R({backgroundImage:`url(${null==(e=Oe.value)?void 0:e.countryPath})`})},null,8,["style"]),F(t,{class:"country-title"},{default:k((()=>{var e;return[P(S(null==(e=Oe.value)?void 0:e.countryTitle),1)]})),_:1})]})),_:1}),F(t,{class:"nick-name"},{default:k((()=>{var e;return[P(S(null==(e=Oe.value)?void 0:e.nickname),1)]})),_:1})])),_:1})]})),_:1}),F(o,{class:"cancel",onClick:l[1]||(l[1]=e=>Re(!0))})])),_:1}),F(o,{class:"chat-status"},{default:k((()=>[F(t,{class:"time-cutdown"},{default:k((()=>[P(S(Le.value),1)])),_:1}),j(F(o,{class:"muted-status",onClick:l[2]||(l[2]=e=>$e(M(n).aivOpenVoice))},{default:k((()=>[F(o,{class:"muted-img"}),F(t,null,{default:k((()=>[P(S(e.$lanKey.off.tr),1)])),_:1})])),_:1},512),[[B,1==Se.value]])])),_:1})])),_:1}),F(o,{class:"bottom-float"},{default:k((()=>[F(u,{ref_key:"paging",ref:Ye,fixed:!1,class:"msg-area","default-theme-style":"white","use-chat-record-mode":"","refresher-only":"",onOnRefresh:Ze},{empty:k((()=>[F(o)])),bottom:k((()=>[j(F(o,{class:"action"},{default:k((()=>[F(o,{class:"input-target",onClick:l[6]||(l[6]=e=>(console.log("占位输入点击"),de.value=!0,void J((()=>{pe.value=!0}))))},{default:k((()=>[F(t,null,{default:k((()=>[P(S(e.$lanKey.pleaseEnter.tr),1)])),_:1}),F(o,{onClick:l[5]||(l[5]=e=>ye(e)),class:"input-icon-emoji"})])),_:1}),F(o,{onClick:l[7]||(l[7]=e=>ze.value=!ze.value),class:x(["cover",ze.value?"cover-close":"cover-open"])},{default:k((()=>[F(o,{class:x(["cover-icon",ze.value?"cover-icon-close":"cover-icon-open"])},null,8,["class"])])),_:1},8,["class"]),F(o,{class:"action-recharge-gift"},{default:k((()=>[F(o,{class:"recharge",onClick:l[8]||(l[8]=e=>$e(1==Pe.value?M(n).aivRechargeBtn:M(n).callRechargeBtn))},{default:k((()=>[F(o,{class:"recharge-icon"})])),_:1}),F(o,{class:"gift-action",onClick:l[9]||(l[9]=e=>Ie(!0))})])),_:1})])),_:1},512),[[B,!de.value]]),j(F(o,{class:"input-area"},{default:k((()=>[F(o,{class:"input-content"},{default:k((()=>[F(s,{id:"inputElement",onConfirm:me,"confirm-type":"send",type:"text",cursor:fe.value,focus:pe.value,modelValue:ve.value,"onUpdate:modelValue":l[10]||(l[10]=e=>ve.value=e),onFocus:l[11]||(l[11]=e=>{console.log("焦点变动")}),onBlur:he,placeholder:e.$lanKey.pleaseEnter.tr},null,8,["cursor","focus","modelValue","placeholder"]),F(o,{class:"send-area",onClick:me},{default:k((()=>[F(o,{class:"msg-send-action"})])),_:1})])),_:1}),F(o,{class:"input-action-area"},{default:k((()=>[F(o,{onClick:l[12]||(l[12]=e=>ye(e)),class:x(ge.value?"chat-icon chat-action-icon-emoji-s":"chat-icon chat-action-icon-emoji")},null,8,["class"]),F(o,{onClick:l[13]||(l[13]=e=>(de.value=!1,ge.value=!1,void Ie(!0))),class:"chat-icon chat-action-icon-gift"})])),_:1}),j(F(c,{class:"light"},null,512),[[B,ge.value]])])),_:1},512),[[B,de.value]])])),default:k((()=>[j(F(o,null,{default:k((()=>[(y(!0),A(V,null,O(Je.value,((a,s)=>(y(),b(o,{class:"msg",key:s},{default:k((()=>[F(o,{class:"msg-item"},{default:k((()=>[0==a.type?(y(),b(o,{key:0},{default:k((()=>[F(t,{class:"txt-content"},{default:k((()=>[P(S(a.content),1)])),_:2},1024)])),_:2},1024)):3==a.type?(y(),b(o,{key:1,class:"action-content"},{default:k((()=>[F(t,{style:{color:"#7FE5FFFF"},class:"txt"},{default:k((()=>[P(S(M(Ee).nickname)+"：",1)])),_:1}),F(t,{class:"txt"},{default:k((()=>[P(S(a.content),1)])),_:2},1024)])),_:2},1024)):4==a.type?(y(),b(o,{key:2,class:"action-content"},{default:k((()=>[F(t,{style:{color:"#FFF133FF"},class:"txt"},{default:k((()=>[P(S(Oe.value.nickname)+"：",1)])),_:1}),F(t,{class:"txt"},{default:k((()=>[P(S(a.content),1)])),_:2},1024)])),_:2},1024)):1==a.type?(y(),b(o,{key:3,class:"action-content"},{default:k((()=>[F(t,{class:"txt"},{default:k((()=>[P(S(a.content),1)])),_:2},1024),F(o,{class:"action-btn",onClick:l[3]||(l[3]=e=>$e(M(n).aivOpenVoice))},{default:k((()=>[F(t,{style:{color:"#8D5DFFFF"}},{default:k((()=>[P(S(e.$lanKey.videoCallMutedUnlock.tr),1)])),_:1})])),_:1})])),_:2},1024)):2==a.type?(y(),b(o,{key:4,class:"action-content"},{default:k((()=>[F(t,{class:"txt"},{default:k((()=>[P(S(a.content),1)])),_:2},1024),F(o,{class:"action-btn",onClick:l[4]||(l[4]=e=>sl({failTip:!0}))},{default:k((()=>[F(t,{style:{color:"#8D5DFFFF"}},{default:k((()=>[P(S(M(g).toOpen.tr),1)])),_:1})])),_:1})])),_:2},1024)):T("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512),[[B,ze.value]])])),_:1},512)])),_:1}),F(o,{class:"gift-action",onClick:l[14]||(l[14]=e=>Ie(!0))}),F(M(q),{visible:_e.value,"onUpdate:visible":l[16]||(l[16]=e=>_e.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:l[17]||(l[17]=e=>Ie(!1))},{default:k((()=>[F(ce,{userId:Ve.value,onClose:l[15]||(l[15]=e=>_e.value=!1),onChoosedGift:Ce,onShowRecharge:we},null,8,["userId"])])),_:1},8,["visible"]),F(ue,{ref_key:"giftEffectRef",ref:ke,userId:Ve.value,userNickname:Oe.value.nickname,style:{position:"absolute",bottom:"700rpx",left:"0",right:"0"}},null,8,["userId","userNickname"]),F(M(q),{visible:De.value,"onUpdate:visible":l[19]||(l[19]=e=>De.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:l[20]||(l[20]=e=>Ue(!1))},{default:k((()=>[F(G,{anchorId:Ve.value,path:Ae.value,onClose:l[18]||(l[18]=e=>De.value=!1)},null,8,["anchorId","path"])])),_:1},8,["visible"]),F(M(K),{visible:Te.value,"onUpdate:visible":l[21]||(l[21]=e=>Te.value=e),header:!1,closeButton:!1,maxButton:!1,customClass:"modal-custom",onClose:l[22]||(l[22]=e=>Re(!1))},{default:k((()=>[F(L,{title:e.$lanKey.confirmHangUp.tr,onClose:Qe},null,8,["title"])])),_:1},8,["visible"])]})),_:1})}}},[["__scopeId","data-v-5df79e86"]]);export{ie as default};
