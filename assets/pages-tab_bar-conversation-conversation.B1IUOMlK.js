import{_ as e,j as l,u as a,h as t,as as o,H as s,o as n,L as r,e as u,w as i,T as d,O as c,p as f,i as v,P as g,Q as m,a4 as p,R as h,S as y,N as _,d as x,at as k,au as C,av as $,aw as I,a2 as K,a7 as b,a1 as A,ax as w,x as T,a6 as P,a5 as j,f as M}from"./index-SUU5mfSv.js";import{_ as U}from"./z-paging.CcGAQywI.js";import{o as D,c as N,r as F}from"./uni-app.es.BFzw-cPf.js";import{_ as z}from"./logo.CDUkGFg-.js";import{M as H}from"./modal-msg-more-option.DU4XmyW8.js";const L=e({__name:"conversation",setup(e){const L=l(!1),O=e=>{L.value=e},R=()=>{O(!1),a().clearAllConversation()},S=()=>{O(!1),a().readAllConversation()};D((()=>{console.log("会话列表页面出现 刷新角标"),setTimeout((()=>{a().updateConversationBadge()}),250)}));const V=e=>{console.log("遍历消息是否未读");for(const l of e)if(1!=(null==l?void 0:l.read))return!0;return!1},B=e=>{P({url:`/pages/tab_bar/conversation/msg/msg?anchorId=${e}`})},Q=l(0),q=a(),{conversations:E}=t(q),G=l([]),J=l({}),W=()=>{console.log("会话 更新一次会话列表的主播信息");for(const e of E.value)9999!=e.anchorId&&(null!=J.value[e.anchorId]?console.log("会话 已有主播缓存信息"):(console.log("会话 拉取一次主播信息"),$({anchorUserId:e.anchorId,success:l=>{J.value[e.anchorId]=l}})))};o(E,(async(e,l)=>{console.log("会话列表发生改变"),G.value=e,null==l?(console.log("会话 第一次初始化 获取一次会话列表所有会话的主播信息"),W()):e.length!=l.length&&(console.log("会话列表数据发生了增加/减少 获取一次会话列表所有会话的主播信息"),W())}),{immediate:!0});const X=l(),Y=()=>{var e;console.log("刷新会话列表"),f()?q.loadAllConversations({success:()=>{var e;null==(e=X.value)||e.complete(!0)},fail:()=>{var e;null==(e=X.value)||e.complete(!0)}}):null==(e=X.value)||e.complete(!0)};Y();const Z=l(),ee=l(),le=(e,l)=>{I({pageNum:e,pageSize:l,success:e=>{var l;null==(l=ee.value)||l.complete(e.list)},fail:()=>{var e;null==(e=ee.value)||e.complete(!0)},netFail:()=>{var e;null==(e=ee.value)||e.complete(!0)}})},ae=q.$onAction((({name:e})=>{var l;"loginStatusHadChangedNotification"==e&&(console.log("用户登录/退出 通话历史记录监听触发"),null==(l=ee.value)||l.reload())}));return N((()=>{console.log("会话页面销毁 监听取消"),ae()})),(e,l)=>{const a=v,t=M,o=K,f=F(s("z-paging"),U),$=b,I=A;return n(),r(c,null,[u(a,{class:"page-bg conversation-bg"}),u(a,{class:"content-area"},{default:i((()=>[u(a,{class:"b-safe-top"},{default:i((()=>[u(a,{class:"b-status-bar"}),u(a,{class:"b-navbar"},{default:i((()=>[u(a,{style:{padding:"28rpx 20rpx",display:"flex","justify-content":"space-between","align-items":"center"}},{default:i((()=>[u(a,{class:"home_logo"},{default:i((()=>[u(a,{class:"home_logo_logo"}),u(a,{class:"home_logo_logo_text"})])),_:1}),g(u(a,{onClick:l[0]||(l[0]=e=>O(!0)),class:"more-option"},null,512),[[m,0==Q.value]])])),_:1})])),_:1})])),_:1}),u(a,{class:"tab"},{default:i((()=>[u(a,{class:p({"item-select":0==Q.value,item:!0}),onClick:l[1]||(l[1]=e=>Q.value=0)},{default:i((()=>[h(y(e.$lanKey.message.tr),1)])),_:1},8,["class"]),u(a,{class:p({"item-select":0!=Q.value,item:!0}),onClick:l[2]||(l[2]=e=>Q.value=1)},{default:i((()=>[h(y(e.$lanKey.callHistory.tr),1)])),_:1},8,["class"])])),_:1}),u(I,{style:{height:"100%"},"indicator-dots":!1,duration:250,autoplay:!1,current:Q.value,onChange:l[4]||(l[4]=e=>Q.value=e.detail.current)},{default:i((()=>[u($,null,{default:i((()=>[u(f,{fixed:!1,"default-theme-style":"white",ref_key:"paging",ref:X,"refresher-only":"",onOnRefresh:Y,"refresher-default-text":e.$lanKey.refreshPullDown.tr,"refresher-pulling-text":e.$lanKey.refreshPullDown.tr,"refresher-refreshing-text":e.$lanKey.refreshing.tr,"refresher-complete-text":e.$lanKey.refreshPullDown.tr},{default:i((()=>[G.value.length>0?(n(!0),r(c,{key:0},_(G.value,((l,s)=>(n(),x(a,{key:s},{default:i((()=>[u(a,{onClick:e=>B(l.anchorId),class:"conversation-item"},{default:i((()=>{var s;return[9999==l.anchorId?(n(),x(t,{key:0,class:"portrait place-holder-gradient",src:z,mode:"aspectFill"})):(n(),x(t,{key:1,class:"portrait place-holder-gradient",src:null==(s=J.value[l.anchorId])?void 0:s.portrait,mode:"aspectFill"},null,8,["src"])),u(a,{class:"content"},{default:i((()=>[u(a,{class:"top"},{default:i((()=>[u(o,null,{default:i((()=>{var a;return[h(y(9999==l.anchorId?e.$lanKey.officialMessage.tr:null==(a=J.value[l.anchorId])?void 0:a.nickname),1)]})),_:2},1024),u(o,null,{default:i((()=>[h(y(d(w)(null==l?void 0:l.latestTime)),1)])),_:2},1024)])),_:2},1024),u(a,{class:"bottom"},{default:i((()=>{var t,s,r,d,c;return[11==(null==(t=null==l?void 0:l.datas[l.datas.length-1])?void 0:t.messageType)||19==(null==(s=null==l?void 0:l.datas[l.datas.length-1])?void 0:s.messageType)?(n(),x(o,{key:0},{default:i((()=>{var e,a;return[h(y(null==(a=null==(e=null==l?void 0:l.datas[l.datas.length-1])?void 0:e.data)?void 0:a.text),1)]})),_:2},1024)):12==(null==(r=null==l?void 0:l.datas[l.datas.length-1])?void 0:r.messageType)?(n(),x(a,{key:1,class:"icon img-icon"})):(null==(d=null==l?void 0:l.datas[l.datas.length-1])?void 0:d.messageType)<=-50?(n(),x(o,{key:2},{default:i((()=>[h(y(e.$lanKey.notification.tr),1)])),_:1})):(null==(c=null==l?void 0:l.datas[l.datas.length-1])?void 0:c.messageType)<=-40?(n(),x(a,{key:3,class:"icon call-icon"})):(n(),x(o,{key:4},{default:i((()=>[h("...")])),_:1})),g(u(a,{class:"dot"},null,512),[[m,V(null==l?void 0:l.datas)]])]})),_:2},1024)])),_:2},1024)]})),_:2},1032,["onClick"])])),_:2},1024)))),128)):(n(),x(a,{key:1,class:"conversation-empty"},{default:i((()=>[u(o,null,{default:i((()=>[h(y(e.$lanKey.noChatTip.tr),1)])),_:1}),u(o,null,{default:i((()=>[h(y(e.$lanKey.noChatTip2.trArg(d(k))),1)])),_:1})])),_:1}))])),_:1},8,["refresher-default-text","refresher-pulling-text","refresher-refreshing-text","refresher-complete-text"])])),_:1}),u($,null,{default:i((()=>[u(f,{fixed:!1,"default-theme-style":"white",ref_key:"pagingCallHistory",ref:ee,modelValue:Z.value,"onUpdate:modelValue":l[3]||(l[3]=e=>Z.value=e),onQuery:le,"refresher-default-text":e.$lanKey.refreshPullDown.tr,"refresher-pulling-text":e.$lanKey.refreshPullDown.tr,"refresher-refreshing-text":e.$lanKey.refreshing.tr,"refresher-complete-text":e.$lanKey.refreshPullDown.tr,"loading-more-default-text":e.$lanKey.refreshLoadMore.tr,"loading-more-loading-text":e.$lanKey.refreshLoading.tr,"loading-more-no-more-text":e.$lanKey.refreshNoMore.tr,"loading-more-fail-text":e.$lanKey.refreshLoadFail.tr},{loadingMoreNoMore:i((()=>[u(a)])),empty:i((()=>[u(a,{class:"zp-common-empty"})])),default:i((()=>[(n(!0),r(c,null,_(Z.value,((l,s)=>(n(),x(a,{key:s},{default:i((()=>[u(a,{onClick:e=>{return a=l.peerUserId,void P({url:`/pages/anchor-detail/anchor-detail?anchorUserId=${a}`});var a},class:"call-history-item"},{default:i((()=>[u(t,{class:"portrait place-holder-gradient",src:null==l?void 0:l.peerPortrait,mode:"aspectFill"},null,8,["src"]),u(a,{class:"content"},{default:i((()=>[u(a,{class:"info-column"},{default:i((()=>[u(o,null,{default:i((()=>[h(y(null==l?void 0:l.peerNickname),1)])),_:2},1024),u(a,{class:"call-time"},{default:i((()=>[u(a,{class:"icon"}),u(o,null,{default:i((()=>[h(y((null==l?void 0:l.endAt)-(null==l?void 0:l.startAt)<=0?e.$lanKey.notConnected.tr:d(T)(null==l?void 0:l.endAt,null==l?void 0:l.startAt)),1)])),_:2},1024)])),_:2},1024),u(o,null,{default:i((()=>[h(y(d(w)(null==l?void 0:l.createdAt)),1)])),_:2},1024)])),_:2},1024),u(a,{onClick:e=>(e=>{event.stopPropagation(),1==(null==e?void 0:e.peerIsOnline)?j({anchorId:null==e?void 0:e.peerUserId}):B(null==e?void 0:e.peerUserId)})(l),class:p(["action-icon",1==(null==l?void 0:l.peerIsOnline)?"callIcon":"msgIcon"])},null,8,["onClick","class"])])),_:2},1024)])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1},8,["modelValue","refresher-default-text","refresher-pulling-text","refresher-refreshing-text","refresher-complete-text","loading-more-default-text","loading-more-loading-text","loading-more-no-more-text","loading-more-fail-text"])])),_:1})])),_:1},8,["current"])])),_:1}),u(d(C),{visible:L.value,"onUpdate:visible":l[6]||(l[6]=e=>L.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:l[7]||(l[7]=e=>O(!1))},{default:i((()=>[u(H,{read:!0,onReadAllConversation:S,onClearAllMsg:R,onClose:l[5]||(l[5]=e=>L.value=!1)})])),_:1},8,["visible"])],64)}}},[["__scopeId","data-v-431b6326"]]);export{L as default};
