import{_ as e,h as a,u as l,j as s,av as t,z as o,F as n,as as u,aO as c,H as r,o as i,d,w as v,V as m,i as p,e as f,a3 as g,R as y,S as k,W as _,a4 as h,P as b,Q as C,T as I,g as $,L as T,N as j,O as M,au as w,aP as x,an as E,aj as F,ak as U,a5 as B,aQ as D,aR as R,Y as S,aS as q,a2 as A,aT as K,aU as V}from"./index-SUU5mfSv.js";import{_ as G}from"./z-paging.CcGAQywI.js";import{b as N,o as Q,c as z,r as L}from"./uni-app.es.BFzw-cPf.js";import"./picker.CIoOQAKU.js";import{M as P}from"./modal-msg-more-option.DU4XmyW8.js";import{M as H,G as O}from"./gift-effect.7ERhjfhJ.js";const W=e({__name:"msg",setup(e){const{userDetail:W,userHaveChatCard:X}=a(l()),Y=s(m.chatMsgGift),J=s(),Z=e=>{J.value.throwGiftEffect(e)},ee=s(!1),ae=e=>{ee.value=e},le=e=>{0==se.value&&(e&&E({content:e}),Y.value=m.chatMsgGift,te(!0))},se=s(!1),te=e=>{se.value=e},oe=s(!1),ne=e=>{oe.value=e},ue=()=>{1==F().length?history.back():U()};let ce=null;const re=()=>{},ie=s(!1),de=s({}),ve=s(null);N((e=>{ce=e.anchorId,ie.value=9999==ce,ie.value||t({anchorUserId:ce,foreRequest:!0,backLocal:e=>{de.value=e},success:e=>{de.value=e,ve.value=e.sendMsgFlag}})})),Q((()=>{l().readConversation(`${o()}_${ce}`)}));const me=()=>{ne(!1),l().deleteConversation(`${o()}_${ce}`)},pe=s([]),fe=s(),ge=l(),{conversations:ye}=a(ge);let ke=null,_e=[];const he=(e,a)=>{const l=_e[e-1];fe.value.complete(l)};n((()=>{u(ye,(async(e,a)=>{console.log(`消息内页 会话数据发生了改变${ye.value}`),ke=ye.value.find((e=>e.anchorId==ce)),ke?(ke.datas=ke.datas.sort(((e,a)=>e.timestamp-a.timestamp)),_e=((e,a)=>{const l=[];for(let s=0;s<e.length;s+=a)l.push(e.slice(s,s+a));return l})(ke.datas.slice().reverse(),15),fe.value.reload()):(_e=[],fe.value.reload())}),{immediate:!0})}));const be=()=>{B({anchorId:ce,combineAnchor:!0})},Ce=s("");s();const Ie=s(!1),$e=s(0),Te=s(!1),je=s(!1),Me=()=>{if(console.log(`发送消息 ${Ce.value}`),null==ve.value||""==Ce.value);else{const e=ve.value,a=X.value;D({str:Ce.value,receiveId:ce,matchCallBack:s=>{R({recipientId:ce,type:11,content:s,originContent:Ce.value,ignoreNetRequest:null==s,userDetail:W.value,success:()=>{if(null!=s&&!1===e){let e=-100;a?(console.log("非免费的聊天 发送成功一条消息 使用了聊天卡"),e=-50):(console.log("非免费的聊天 发送成功一条消息 使用了钻石"),e=-51);const s=Date.now(),n=o(),u={messageType:e,read:1,timestamp:s,mid:`${n}_${ce}_${s}`};l().addConversation(`${n}_${ce}`,u),1!=ve.value&&t({anchorUserId:ce,foreRequest:!0,success:e=>{de.value=e,ve.value=e.sendMsgFlag}})}},fail:e=>{E({content:e.message,durationSecond:1,callback:()=>{1008==e.code&&(Y.value=m.sendMsg,te(!0))}})}})}}),Ce.value="",$e.value=0,Te.value=!1}};let we=null;const xe=e=>{je.value=e,null!=we?we.restart():we=S({targets:".action-area",scale:[.8,1],autoplay:!0,duration:100,easing:"easeInQuart"})},Ee=()=>{Ie.value=!1,q((()=>{Te.value=!0}))},Fe=()=>{Te.value=!1,setTimeout((()=>{xe(!1)}),100),console.log("失去焦点 记录此时输入框的输入光标位置");const e=document.getElementById("inputElement").querySelector("input").selectionEnd;$e.value=e},Ue=l().$onAction((({name:e})=>{"remoteInvitationReceived"==e&&(console.log("收到了通话请求 关闭礼物弹窗"),ae(!1))}));return z((()=>{console.log("消息页面销毁 监听取消"),Ue()})),(e,a)=>{const s=p,n=A,u=K,F=c("emoji-picker"),U=L(r("z-paging"),G);return i(),d(s,{class:"conversation-content"},{default:v((()=>[f(U,{ref_key:"paging",ref:fe,fixed:!1,modelValue:pe.value,"onUpdate:modelValue":a[5]||(a[5]=e=>pe.value=e),"use-chat-record-mode":"",onQuery:he},{empty:v((()=>[f(s)])),top:v((()=>[f(s,{class:"b-safe-top"},{default:v((()=>[f(s,{class:"b-status-bar"}),f(s,{class:"b-navbar msg-nav"},{default:v((()=>[f(s,{class:"nav-back msg-nav"},{default:v((()=>[f(s,{onClick:ue,class:"arrow-right transX"}),f(s,{onClick:re,class:"anchor-detail"},{default:v((()=>{var a;return[ie.value?(i(),d(s,{key:0,class:"offical-portrait"})):(i(),d(s,{key:1,class:"anchor-portrait",style:g({backgroundImage:`url(${null==(a=de.value)?void 0:a.portrait})`})},null,8,["style"])),f(s,{class:"anchor-info"},{default:v((()=>[ie.value?_("",!0):(i(),d(s,{key:0,class:"area"},{default:v((()=>{var e;return[f(s,{class:"countryIcon",style:g({backgroundImage:`url(${null==(e=de.value)?void 0:e.countryPath})`})},null,8,["style"]),f(n,{class:"country-title"},{default:v((()=>{var e;return[y(k(null==(e=de.value)?void 0:e.countryTitle),1)]})),_:1})]})),_:1})),f(n,{class:"nick-name"},{default:v((()=>{var a;return[y(k(ie.value?e.$lanKey.officialMessage.tr:null==(a=de.value)?void 0:a.nickname),1)]})),_:1})])),_:1})]})),_:1})])),_:1}),f(s,{onClick:a[0]||(a[0]=e=>ne(!0)),class:"more-option"})])),_:1})])),_:1})])),bottom:v((()=>[ie.value?_("",!0):(i(),d(s,{key:0,class:"input-area"},{default:v((()=>[f(s,{class:"input-content"},{default:v((()=>[f(s,{onClick:a[1]||(a[1]=e=>(Ie.value=!Ie.value,void q((()=>{if(Ie.value){const e=document.createElement("style");e.textContent=".search-row, .pad-top { display: none; }",document.querySelector("emoji-picker").shadowRoot.appendChild(e),document.querySelector("emoji-picker").addEventListener("emoji-click",(e=>{const a=e.detail.unicode;document.getElementById("inputElement").querySelector("input");const l=$e.value,s=$e.value;Ce.value=Ce.value.slice(0,l)+a+Ce.value.slice(s),$e.value=$e.value+a.length}))}else Te.value=!0})))),class:h(["input-icon",Ie.value?"input-icon-keyboard":"input-icon-emoji"])},null,8,["class"]),f(s,{class:"input-real"},{default:v((()=>[f(u,{id:"inputElement",onConfirm:Me,"confirm-type":"send",type:"text",cursor:$e.value,focus:Te.value,modelValue:Ce.value,"onUpdate:modelValue":a[2]||(a[2]=e=>Ce.value=e),onFocus:a[3]||(a[3]=e=>xe(!0)),onBlur:Fe,placeholder:e.$lanKey.pleaseEnter.tr},null,8,["cursor","focus","modelValue","placeholder"]),b(f(s,{class:"input-cover",onClick:Ee},null,512),[[C,Ie.value]])])),_:1}),0==ve.value?(i(),d(s,{key:0,class:"float-tip"},{default:v((()=>[I(X)?(i(),d(s,{key:0,class:"tip"},{default:v((()=>[f(s,{class:"props props-chat"}),f(n,{class:"txt"},{default:v((()=>[y(k(e.$lanKey.free.tr),1)])),_:1})])),_:1})):(i(),d(s,{key:1,class:"tip tip-cost-tip"},{default:v((()=>[f(n,{class:".cost-txt"},{default:v((()=>{var a;return[y(k(e.$lanKey.unlockChatTip.trArg(null==(a=I($)())?void 0:a.chatCardDiamonds.toBin)),1)]})),_:1})])),_:1})),f(s,{class:h(["down-arrow",{"down-arrow-cost-tip":!I(X)}])},null,8,["class"])])),_:1})):_("",!0)])),_:1}),f(s,{class:"action-area"},{default:v((()=>[je.value?(i(),d(s,{key:1,onClick:Me,class:"action-area-bg",style:{"background-color":"#8D5DFFFF"}},{default:v((()=>[f(s,{class:"msg-send-action"})])),_:1})):(i(),d(s,{key:0,class:"actions"},{default:v((()=>[f(s,{onClick:be,class:"action-area-bg"},{default:v((()=>[f(s,{class:"call-action"})])),_:1}),f(s,{onClick:a[4]||(a[4]=e=>ae(!0)),class:"action-area-bg"},{default:v((()=>[f(s,{class:"gift-action"})])),_:1})])),_:1}))])),_:1})])),_:1})),b(f(F,{class:"dark"},null,512),[[C,Ie.value]])])),default:v((()=>[(i(!0),T(M,null,j(pe.value,((a,u)=>{var c;return i(),d(s,{class:h(["msg-item",{"msg-item-me":(null==(c=null==a?void 0:a.userInfo)?void 0:c.uid)==I(o)()}]),key:u},{default:v((()=>{return[(c=a,r=pe.value[u+1],null==(null==r?void 0:r.timestamp)||Math.abs(c.timestamp-r.timestamp)>6e5?(i(),d(n,{key:0,class:"time"},{default:v((()=>[y(k(I(V)(a.timestamp)),1)])),_:2},1024)):_("",!0)),-50==a.messageType||-51==a.messageType?(i(),d(n,{key:1,class:"notification"},{default:v((()=>{var l,s;return[y(k(-50==a.messageType?e.$lanKey.unlockChatByCard.trArg(null==(l=I($)())?void 0:l.chatCardDays):e.$lanKey.unlockChatByDiamond.trArg(null==(s=I($)())?void 0:s.chatCardDays)),1)]})),_:2},1024)):-52==a.messageType?(i(),d(s,{key:2,class:"gift-content"},{default:v((()=>{var e;return[f(n,{class:"gift-count"},{default:v((()=>{var e;return[y("x "+k(null==(e=null==a?void 0:a.data)?void 0:e.count),1)]})),_:2},1024),f(s,{class:"gift-icon",style:g({backgroundImage:`url(${null==(e=null==a?void 0:a.data)?void 0:e.imageUrl})`})},null,8,["style"])]})),_:2},1024)):_("",!0),a.messageType>-50?(i(),d(s,{key:3,onClick:e=>(e=>{if(-43==(null==e?void 0:e.messageType)||-44==(null==e?void 0:e.messageType))B({anchorId:ce,combineAnchor:!0});else if(1==(null==e?void 0:e.sendFail)){console.log("消息重发");const a=ve.value,s=X.value;R({recipientId:ce,reSendMsg:e,success:()=>{if(!1===a){let e=-100;s?(console.log("非免费的聊天 发送成功一条消息 使用了聊天卡"),e=-50):(console.log("非免费的聊天 发送成功一条消息 使用了钻石"),e=-51);const a=Date.now(),n=o(),u={messageType:e,read:1,timestamp:a,mid:`${n}_${ce}_${a}`};l().addConversation(`${n}_${ce}`,u),1!=ve.value&&t({anchorUserId:ce,foreRequest:!0,success:e=>{de.value=e,ve.value=e.sendMsgFlag}})}},fail:e=>{E({content:e.message,durationSecond:1,callback:()=>{1008==e.code&&(Y.value=m.sendMsg,te(!0))}})}})}})(a),class:"msg-content"},{default:v((()=>{var l;return[1==(null==a?void 0:a.sendFail)?(i(),d(s,{key:0,class:"send-fail"})):_("",!0),f(s,{class:h(["msg-body",(null==(l=null==a?void 0:a.userInfo)?void 0:l.uid)==I(o)()?"border-radius-me":"border-radius"])},{default:v((()=>{var l;return[-43==a.messageType||-44==a.messageType?(i(),d(s,{key:0,class:"call-icon"})):_("",!0),11==a.messageType||19==a.messageType||-43==a.messageType?(i(),d(n,{key:1,class:"txt-content"},{default:v((()=>[y(k(a.data.text),1)])),_:2},1024)):-44==a.messageType?(i(),d(n,{key:2,class:"txt-content"},{default:v((()=>[y(k(e.$lanKey.notConnected.tr),1)])),_:1})):12==a.messageType?(i(),d(s,{key:3,class:"img-content",style:g({backgroundImage:`url(${null==(l=null==a?void 0:a.data)?void 0:l.imageUrl})`})},null,8,["style"])):(i(),d(s,{key:4}))]})),_:2},1032,["class"])]})),_:2},1032,["onClick"])):_("",!0)];var c,r})),_:2},1032,["class"])})),128))])),_:1},8,["modelValue"]),f(I(w),{visible:ee.value,"onUpdate:visible":a[7]||(a[7]=e=>ee.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:a[8]||(a[8]=e=>ae(!1))},{default:v((()=>[f(H,{userId:I(ce),onClose:a[6]||(a[6]=e=>ee.value=!1),onChoosedGift:Z,onShowRecharge:le},null,8,["userId"])])),_:1},8,["visible"]),f(O,{ref_key:"giftEffectRef",ref:J,userId:I(ce),userNickname:de.value.nickname,style:{position:"absolute",bottom:"700rpx",left:"0",right:"0"}},null,8,["userId","userNickname"]),f(I(w),{visible:se.value,"onUpdate:visible":a[10]||(a[10]=e=>se.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:a[11]||(a[11]=e=>te(!1))},{default:v((()=>[f(x,{anchorId:I(ce),path:Y.value,onClose:a[9]||(a[9]=e=>se.value=!1)},null,8,["anchorId","path"])])),_:1},8,["visible"]),f(I(w),{visible:oe.value,"onUpdate:visible":a[13]||(a[13]=e=>oe.value=e),backdropClose:!0,header:!1,closeButton:!1,placement:"bottom",customClass:"modal-custom",onClose:a[14]||(a[14]=e=>ne(!1))},{default:v((()=>[f(P,{onClearAllMsg:me,onClose:a[12]||(a[12]=e=>oe.value=!1)})])),_:1},8,["visible"])])),_:1})}}},[["__scopeId","data-v-9c621fee"]]);export{W as default};
