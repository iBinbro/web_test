import{_ as a,h as l,u as e,j as o,ae as n,af as s,k as c,z as u,p as t,a0 as i,ag as v,ah as r,o as d,d as h,w as m,g,U as f,V as p,ai as y,i as I,a4 as _,e as k,R as $,S as T,P as S,Q as C,aj as U,ak as b,al as D,am as F,f as M,a2 as j,an as K,ao as N,ap as R,aq as w,ar as A}from"./index-SUU5mfSv.js";import{b as B,c as x}from"./uni-app.es.BFzw-cPf.js";const H=a({__name:"matching",setup(a){const{userHaveMatchCard:H,userDetail:J}=l(e()),P=()=>{E();1==U().length?history.back():b()};let q=[];const z=o(!1),E=()=>{null!=G&&(console.log(`匹配 取消已创建的频道号 ${G}`),w({channelId:G,endType:0}),G=null)},L=o(null),O=o(!0),Q=o(!0);let V,G=null;const W=e().$onAction((({name:a,args:l})=>{"localInvitationSendSuccess"==a?(console.log("匹配 邀请发送成功 倒计时10s 未接通则取消本地邀请"),V=clearTimeout(V),V=setTimeout((()=>{console.log("匹配 取消本地邀请 继续匹配"),E(),r(),la({force:!0})}),1e4)):"localInvitationAccepted"==a?(V=clearTimeout(V),console.log(`匹配 本地邀请被主播接受 加入通话 ${l}`),n({key:"videoCallChannelId",value:l[0],success:()=>{s({url:"/pages/video-chat/video-chat"});let a=c(`${u()}_match_count`);""!=a&&null!=a&&null!=a||(a=0),n({key:`${u()}_match_count`,value:a+1})},fail:()=>{O.value=!1,L.value=null}})):"localInvitationRefused"==a?(console.log("匹配 本地邀请被主播拒绝 继续匹配"),V=clearTimeout(V),la({force:!0})):"localInvitationSendSFail"==a&&(console.log("本地邀请发送失败 继续匹配"),la({force:!0}))})),X=(a,l)=>{l&&(a.type=1,a.url=a.videoUrl),L.value=a,O.value=!1,a.callType=2,n({key:"videoCallData",value:a,success:()=>{if(1==(null==a?void 0:a.type)){console.log("匹配 匹配到虚拟视频"),s({url:"/pages/video-chat/video-chat"});let a=c(`${u()}_match_count`);""!=a&&null!=a&&null!=a||(a=0),n({key:`${u()}_match_count`,value:a+1})}else{console.log("匹配 匹配到真实主播 创建频道 发送通话请求");const l=N({anchorUserId:a.anchorUserId,type:2,success:l=>{G=l,R({peerId:a.anchorUserId,userInfo:JSON.stringify(J.value),channelId:l})},fail:a=>{console.log("匹配 创建频道失败"),O.value=!1,L.value=null,1008==(null==a?void 0:a.code)?K({content:a.message,durationSecond:1,callback:()=>{f({path:p.matchNoMoney})}}):K({content:a.message,durationSecond:1})},netFail:()=>{O.value=!1,L.value=null}});q.push(l)}},fail:()=>{O.value=!1,L.value=null}})},Y=a=>{if(O.value=!0,a){const a=D({success:a=>{v(),null!=(null==a?void 0:a.anchorUserId)&&null!=(null==a?void 0:a.anchorUserId)&&""!=(null==a?void 0:a.anchorUserId)?X(a,!0):(console.log("匹配 失败"),O.value=!1,L.value=null)},fail:a=>{v(),console.log("匹配 失败"),O.value=!1,L.value=null},netFail:()=>{v(),O.value=!1,L.value=null}});q.push(a)}else{const a=F({success:a=>{v(),X(a,!1)},fail:a=>{v(),console.log("匹配 失败"),O.value=!1,L.value=null,1008==(null==a?void 0:a.code)&&K({content:a.message,durationSecond:1,callback:()=>{f({path:p.matchNoMoney})}})},netFail:()=>{v(),O.value=!1,L.value=null}});q.push(a)}};let Z;const aa=(a,l)=>{var e,o;if(null!=(null==(e=J.value)?void 0:e.remainDiamonds)&&null!=(null==(o=J.value)?void 0:o.remainDiamonds)){if(a&&!H.value&&J.value.remainDiamonds<g().matchCardDiamonds)return console.log("匹配 用户没有匹配卡余额也不够"),void f({path:p.matchNoMoney});Q.value=!1,O.value=!0,E(),y(),console.log("匹配 开启匹配接口延迟定时器"),Z=clearTimeout(Z),Z=setTimeout((()=>{console.log("匹配 执行匹配接口"),(l||null==L.value)&&Y(a)}),2e3)}else console.log("匹配 用户可能进行了刷新页面操作 页面恢复为匹配Ready状态")},la=({force:a=!1})=>{if(t()){!0===c("devicePermission")||J.value.totalRecharge>0?(console.log("匹配 已授权情况下/已充值 真实匹配"),aa(!1,a)):(console.log("匹配 权限未知/拒绝 一直虚拟视频"),aa(!0,a))}else i()};let ea;la({});let oa=1;const na=o(".");return B((()=>{A({matchBusy:!0,action:!0}),ea=setInterval((()=>{oa=(oa+1)%4,na.value=".".repeat(oa)}),500)})),x((()=>{console.log("匹配 匹配页面释放"),A({matchBusy:!0,action:!1}),v(),W(),r(),ea=clearInterval(ea),Z=clearTimeout(Z),V=clearTimeout(V),q.forEach((a=>{null==a||a.abort()}))})),(a,l)=>{const e=M,o=j,n=I;return d(),h(n,{class:"match-bg theme-gradient"},{default:m((()=>[0==O.value&&null==L.value?(d(),h(e,{key:0,class:"match-ani-fail"})):(d(),h(e,{key:1,class:_(["match-ani",{"match-ani-place":!z.value}]),src:"/no_pwa/assets/match-ani-C_JmuBHc.webp",onLoad:l[0]||(l[0]=a=>z.value=!0)},null,8,["class"])),k(o,null,{default:m((()=>[$(T(Q.value||0==O.value&&null==L.value?Q.value?"":a.$lanKey.matchFail.tr:`${a.$lanKey.matching.tr} ${na.value}`),1)])),_:1}),S(k(n,{onClick:l[1]||(l[1]=a=>la({})),class:"rematch"},{default:m((()=>[$(T(Q.value?a.$lanKey.startMatch.tr:a.$lanKey.matchAgain.tr),1)])),_:1},512),[[C,Q.value||0==O.value&&null==L.value]]),k(n,{class:"close",onClick:P})])),_:1})}}},[["__scopeId","data-v-f752280d"]]);export{H as default};
